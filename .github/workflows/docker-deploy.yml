name: Docker CI/CD

on:
  push:
    branches: [main] # Production deploy only
  pull_request: # PR builds
    branches: ["**"]
  workflow_dispatch: # Manual trigger
    inputs:
      branch:
        description: "Branch to build (leave empty for current branch)"
        required: false
        default: ""
      tag_prefix:
        description: "Tag prefix (e.g., manual, test, staging)"
        required: false
        default: "manual"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Set Build Tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_PREFIX="${{ github.event.inputs.tag_prefix }}"
            BRANCH_NAME="${{ github.event.inputs.branch }}"
            if [ -z "$BRANCH_NAME" ]; then
              BRANCH_NAME="${{ github.ref_name }}"
            fi
            # Sanitize branch name (replace / with -)
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's|/|-|g')
            echo "BUILD_TAG=${TAG_PREFIX}-${BRANCH_NAME}-${{ github.run_number }}" >> $GITHUB_ENV
            echo "IS_MANUAL=true" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR builds get pr- prefix
            echo "BUILD_TAG=pr-${{ github.run_number }}" >> $GITHUB_ENV
            echo "IS_MANUAL=false" >> $GITHUB_ENV
          else
            # Main branch builds get build- prefix
            echo "BUILD_TAG=build-${{ github.run_number }}" >> $GITHUB_ENV

            echo "IS_MANUAL=false" >> $GITHUB_ENV
          fi

      - name: Display Build Info
        run: |
          echo "Build Tag: ${{ env.BUILD_TAG }}"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Is Manual: ${{ env.IS_MANUAL }}"

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # Build image with build number
      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${{ env.BUILD_TAG }} .

      - name: Push Build Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${{ env.BUILD_TAG }}

      # Only MAIN branch â†’ production deploy (automatic pushes only)
      - name: Tag as Latest (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${{ env.BUILD_TAG }} \
                     ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:latest

      - name: Push Latest (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: docker push ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:latest

      # Tag manual builds with their branch name
      - name: Tag Manual Build
        if: github.event_name == 'workflow_dispatch'
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch }}"
          if [ -z "$BRANCH_NAME" ]; then
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's|/|-|g')
          docker tag ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${{ env.BUILD_TAG }} \
                     ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${BRANCH_NAME}

      - name: Push Manual Build Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch }}"
          if [ -z "$BRANCH_NAME" ]; then
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's|/|-|g')
          docker push ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${BRANCH_NAME}
          docker push ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${{ env.BUILD_TAG }}

      # Cleanup old images - PR builds (keep only current)
      - name: Cleanup PR Build Images
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ§¹ Starting PR build image cleanup..."

          # Get Docker Hub API token
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${{ secrets.DOCKER_USERNAME }}\",\"password\":\"${{ secrets.DOCKER_PASSWORD }}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r '.token // empty')

          if [ -z "$TOKEN" ]; then
            echo "âŒ Failed to authenticate with Docker Hub"
            exit 1
          fi

          echo "âœ… Authenticated with Docker Hub"

          # List all PR tags (pr-* pattern) sorted by build number (newest first)
          TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
            "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/?page_size=100" \
            2>/dev/null | jq -r '.results[] | select(.name | startswith("pr-")) | .name' | sort -rn -t- -k2)

          if [ -z "$TAGS" ]; then
            echo "â„¹ï¸ No PR build tags found"
            exit 0
          fi

          COUNT=$(echo "$TAGS" | wc -l)
          echo "Found $COUNT PR build tag(s)"

          # Keep only the latest PR build, delete older ones
          if [ "$COUNT" -gt 1 ]; then
            echo "ðŸ§¹ Cleaning up old PR builds (keeping only the latest)..."
            TAGS_TO_DELETE=$(echo "$TAGS" | tail -n +2)
            
            while IFS= read -r TAG; do
              if [ -n "$TAG" ]; then
                echo "  Deleting: $TAG"
                STATUS=$(curl -s -w "%{http_code}" -o /dev/null -X DELETE \
                  -H "Authorization: JWT $TOKEN" \
                  "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/$TAG/")
                
                if [ "$STATUS" = "204" ] || [ "$STATUS" = "200" ]; then
                  echo "  âœ… Deleted: $TAG"
                else
                  echo "  âš ï¸ Failed to delete $TAG (HTTP $STATUS)"
                fi
              fi
            done
          else
            echo "âœ… No cleanup needed for PR builds (only $COUNT build)"
          fi

      # Cleanup old images - Main branch (keep 2 versions: current + previous)
      - name: Cleanup Main Branch Images
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Starting main branch build image cleanup..."

          # Get Docker Hub API token
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${{ secrets.DOCKER_USERNAME }}\",\"password\":\"${{ secrets.DOCKER_PASSWORD }}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r '.token // empty')

          if [ -z "$TOKEN" ]; then
            echo " Failed to authenticate with Docker Hub"
            exit 1
          fi

          echo " Authenticated with Docker Hub"

          # List all build tags (build-* pattern) sorted by number (newest first)
          TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
            "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/?page_size=100" \
            2>/dev/null | jq -r '.results[] | select(.name | startswith("build-")) | .name' | sort -rn -t- -k2)

          COUNT=$(echo "$TAGS" | grep -c . || echo 0)
          echo "Found $COUNT build tags"

          # Keep only latest 2 build tags for main branch, delete others
          if [ $COUNT -gt 2 ]; then
            echo "Cleaning up old main branch images (keeping 2 most recent)..."
            TAGS_TO_DELETE=$(echo "$TAGS" | tail -n +3)
            
            echo "$TAGS_TO_DELETE" | while read TAG; do
              echo "  Deleting: $TAG"
              STATUS=$(curl -s -w "%{http_code}" -o /dev/null -X DELETE \
                -H "Authorization: JWT $TOKEN" \
                "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/$TAG/")
              
              if [ "$STATUS" = "204" ] || [ "$STATUS" = "200" ]; then
                echo "  Deleted: $TAG"
              else
                echo " Failed to delete $TAG (HTTP $STATUS)"
              fi
            done
          else
            echo "No cleanup needed for main branch (only $COUNT builds)"
          fi

      - name: Trigger Render Deploy (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
