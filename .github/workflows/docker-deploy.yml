name: Docker CI/CD

on:
  push:
    branches: [main] # Production deploy only
  pull_request: # PR builds
    branches: ["**"]
  workflow_dispatch: # Manual trigger
    inputs:
      branch:
        description: "Branch to build (leave empty for current branch)"
        required: false
        default: ""
      tag_prefix:
        description: "Tag prefix (e.g., manual, test, staging)"
        required: false
        default: "manual"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Set Build Tag
        run: |
          # All builds use the same format: build-{run_number}
          echo "BUILD_TAG=build-${{ github.run_number }}" >> $GITHUB_ENV

          # Determine build type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "BUILD_TYPE=manual" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "BUILD_TYPE=pr" >> $GITHUB_ENV
          else
            echo "BUILD_TYPE=main" >> $GITHUB_ENV
          fi

      - name: Display Build Info
        run: |
          echo "Build Tag: ${{ env.BUILD_TAG }}"
          echo "Build Type: ${{ env.BUILD_TYPE }}"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # Build image with build number
      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${{ env.BUILD_TAG }} .

      - name: Push Build Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${{ env.BUILD_TAG }}

      # Only MAIN branch â†’ production deploy (automatic pushes only)
      - name: Tag as Latest (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:${{ env.BUILD_TAG }} \
                     ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:latest

      - name: Push Latest (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: docker push ${{ secrets.DOCKER_USERNAME }}/gmail-cleaner:latest

      # Cleanup old images - PR builds (keep only current)
      - name: Cleanup PR Build Images
        if: github.event_name == 'pull_request'
        run: |
          echo "Starting PR build image cleanup..."

          # Get Docker Hub API token
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${{ secrets.DOCKER_USERNAME }}\",\"password\":\"${{ secrets.DOCKER_PASSWORD }}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r '.token // empty')

          if [ -z "$TOKEN" ]; then
            echo "Failed to authenticate with Docker Hub"
            exit 1
          fi

          echo "Authenticated with Docker Hub"

          # For PR builds: List all build-* tags
          ALL_TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
            "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/?page_size=100" \
            2>/dev/null | jq -r '.results[] | select(.name | startswith("build-")) | .name' | sort -rn -t- -k2)

          if [ -z "$ALL_TAGS" ]; then
            echo "No build tags found for this PR"
            exit 0
          fi

          COUNT=$(echo "$ALL_TAGS" | wc -l)
          echo "Found $COUNT build tag(s) from this PR"

          # Keep only the latest build, delete all older ones
          if [ "$COUNT" -gt 1 ]; then
            echo "Cleaning up old PR builds (keeping only the latest)..."
            TAGS_TO_DELETE=$(echo "$ALL_TAGS" | tail -n +2)
            
            while IFS= read -r TAG; do
              if [ -n "$TAG" ]; then
                echo "  Deleting tag: $TAG"
                
                # Get the digest for tracking
                DIGEST=$(curl -s -H "Authorization: JWT $TOKEN" \
                  "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/$TAG/" \
                  2>/dev/null | jq -r '.images[0].digest // empty')
                
                # Delete the tag (this triggers garbage collection)
                TAG_STATUS=$(curl -s -w "%{http_code}" -o /dev/null -X DELETE \
                  -H "Authorization: JWT $TOKEN" \
                  "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/$TAG/")
                
                if [ "$TAG_STATUS" = "204" ] || [ "$TAG_STATUS" = "200" ]; then
                  if [ -n "$DIGEST" ] && [ "$DIGEST" != "null" ]; then
                    echo "  Deleted tag: $TAG (digest: ${DIGEST:0:12}...)"
                  else
                    echo "  Deleted tag: $TAG"
                  fi
                else
                  echo "  Failed to delete tag $TAG (HTTP $TAG_STATUS)"
                fi
              fi
            done
          else
            echo "No cleanup needed for PR builds (only $COUNT build)"
          fi

      # Cleanup old images - Main branch (keep 2 build tags + latest tag)
      - name: Cleanup Main Branch Images
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Starting main branch build image cleanup..."

          # Get Docker Hub API token
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${{ secrets.DOCKER_USERNAME }}\",\"password\":\"${{ secrets.DOCKER_PASSWORD }}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r '.token // empty')

          if [ -z "$TOKEN" ]; then
            echo "Failed to authenticate with Docker Hub"
            exit 1
          fi

          echo "Authenticated with Docker Hub"

          # List all build tags (build-* pattern) sorted by number (newest first)
          ALL_TAGS=$(curl -s -H "Authorization: JWT $TOKEN" \
            "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/?page_size=100" \
            2>/dev/null | jq -r '.results[] | select(.name | startswith("build-")) | .name' | sort -rn -t- -k2)

          if [ -z "$ALL_TAGS" ]; then
            echo "No build tags found"
            exit 0
          fi

          COUNT=$(echo "$ALL_TAGS" | wc -l)
          echo "Found $COUNT build tags"

          # Keep only latest 2 build tags for main branch, delete others
          if [ "$COUNT" -gt 2 ]; then
            echo "Cleaning up old main branch images (keeping 2 most recent)..."
            TAGS_TO_DELETE=$(echo "$ALL_TAGS" | tail -n +3)
            
            while IFS= read -r TAG; do
              if [ -n "$TAG" ]; then
                echo "  Deleting tag: $TAG"
                
                # Get the digest for tracking
                DIGEST=$(curl -s -H "Authorization: JWT $TOKEN" \
                  "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/$TAG/" \
                  2>/dev/null | jq -r '.images[0].digest // empty')
                
                # Delete the tag (this triggers garbage collection)
                TAG_STATUS=$(curl -s -w "%{http_code}" -o /dev/null -X DELETE \
                  -H "Authorization: JWT $TOKEN" \
                  "https://hub.docker.com/v2/repositories/${{ secrets.DOCKER_USERNAME }}/gmail-cleaner/tags/$TAG/")
                
                if [ "$TAG_STATUS" = "204" ] || [ "$TAG_STATUS" = "200" ]; then
                  if [ -n "$DIGEST" ] && [ "$DIGEST" != "null" ]; then
                    echo "  Deleted tag: $TAG (digest: ${DIGEST:0:12}...)"
                  else
                    echo "  Deleted tag: $TAG"
                  fi
                else
                  echo "  Failed to delete tag $TAG (HTTP $TAG_STATUS)"
                fi
              fi
            done
          else
            echo "No cleanup needed for main branch (only $COUNT builds, keeping 2 + latest)"
          fi

      - name: Trigger Render Deploy (main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
